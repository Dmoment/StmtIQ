#!/usr/bin/env bash
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
ENV_FILE="$PROJECT_DIR/.env.kamal"

echo -e "${GREEN}=== StmtIQ Deployment Script ===${NC}"

# Check if .env.kamal exists
if [ ! -f "$ENV_FILE" ]; then
  echo -e "${RED}Error: .env.kamal not found!${NC}"
  echo "Please create .env.kamal with your deployment secrets."
  exit 1
fi

# Load environment variables from .env.kamal
echo -e "${YELLOW}Loading environment variables from .env.kamal...${NC}"
set -a
source "$ENV_FILE"
set +a

# Validate required variables
REQUIRED_VARS=(
  "KAMAL_REGISTRY_PASSWORD"
  "RAILS_MASTER_KEY"
  "POSTGRES_PASSWORD"
  "CLERK_PUBLISHABLE_KEY"
  "CLERK_SECRET_KEY"
  "OPENAI_API_KEY"
  "GOOGLE_CLIENT_ID"
  "GOOGLE_CLIENT_SECRET"
)

MISSING_VARS=()
for var in "${REQUIRED_VARS[@]}"; do
  if [ -z "${!var}" ] || [ "${!var}" == "REPLACE_WITH_DOCKER_HUB_TOKEN" ] || [ "${!var}" == "REPLACE_ME" ]; then
    MISSING_VARS+=("$var")
  fi
done

if [ ${#MISSING_VARS[@]} -ne 0 ]; then
  echo -e "${RED}Error: Missing or placeholder values for:${NC}"
  for var in "${MISSING_VARS[@]}"; do
    echo "  - $var"
  done
  echo ""
  echo "Please update .env.kamal with actual values."
  exit 1
fi

echo -e "${GREEN}All required variables loaded!${NC}"

# Parse command
COMMAND="${1:-deploy}"

case "$COMMAND" in
  setup)
    echo -e "${YELLOW}Running initial setup...${NC}"
    echo "This will:"
    echo "  1. Install Docker on the server"
    echo "  2. Deploy PostgreSQL and Redis"
    echo "  3. Build and deploy the app"
    echo ""
    read -p "Continue? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      kamal setup
    fi
    ;;

  deploy)
    echo -e "${YELLOW}Deploying latest changes...${NC}"
    kamal deploy
    ;;

  console)
    echo -e "${YELLOW}Opening Rails console...${NC}"
    kamal console
    ;;

  logs)
    echo -e "${YELLOW}Streaming logs...${NC}"
    kamal logs -f
    ;;

  rollback)
    echo -e "${YELLOW}Rolling back to previous version...${NC}"
    kamal rollback
    ;;

  restart)
    echo -e "${YELLOW}Restarting app...${NC}"
    kamal app restart
    ;;

  shell)
    echo -e "${YELLOW}Opening shell on server...${NC}"
    kamal shell
    ;;

  db:migrate)
    echo -e "${YELLOW}Running database migrations...${NC}"
    kamal app exec "bin/rails db:migrate"
    ;;

  db:seed)
    echo -e "${YELLOW}Running database seeds...${NC}"
    kamal app exec "bin/rails db:seed"
    ;;

  status)
    echo -e "${YELLOW}Checking deployment status...${NC}"
    kamal details
    ;;

  env)
    echo -e "${YELLOW}Current environment variables:${NC}"
    echo "DEPLOY_SERVER_IP: $DEPLOY_SERVER_IP"
    echo "DEPLOY_HOST: $DEPLOY_HOST"
    echo "DOCKER_REGISTRY_USERNAME: $DOCKER_REGISTRY_USERNAME"
    echo "CLERK_ISSUER: $CLERK_ISSUER"
    echo ""
    echo "Secrets loaded: $([ -n "$KAMAL_REGISTRY_PASSWORD" ] && echo 'Yes' || echo 'No')"
    ;;

  *)
    echo "Usage: bin/deploy [command]"
    echo ""
    echo "Commands:"
    echo "  setup      - First-time setup (installs Docker, deploys everything)"
    echo "  deploy     - Deploy latest changes (default)"
    echo "  console    - Open Rails console"
    echo "  logs       - Stream application logs"
    echo "  rollback   - Rollback to previous version"
    echo "  restart    - Restart the application"
    echo "  shell      - Open shell on server"
    echo "  db:migrate - Run database migrations"
    echo "  db:seed    - Run database seeds"
    echo "  status     - Check deployment status"
    echo "  env        - Show loaded environment variables"
    ;;
esac
